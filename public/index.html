<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pico Servo Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background:#0f172a; font-family:'Segoe UI',sans-serif; }
        .glass      { background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); backdrop-filter:blur(12px); }
        .glass-dark { background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.07); }
        .card-sensor{ background:linear-gradient(135deg,#1c2e4a,#0f1e30); border:1px solid #2563eb33; }
        .card-servo { background:linear-gradient(135deg,#2d1b69,#1a0f3d); border:1px solid #7c3aed33; }

        /* Toggle */
        .toggle-track { width:46px;height:26px;border-radius:13px;position:relative;cursor:pointer;transition:background .25s; }
        .toggle-track.on  { background:#22c55e; }
        .toggle-track.off { background:#475569; }
        .toggle-thumb { width:20px;height:20px;border-radius:10px;background:#fff;position:absolute;top:3px;transition:left .25s;box-shadow:0 1px 3px #0009; }
        .toggle-track.on  .toggle-thumb { left:23px; }
        .toggle-track.off .toggle-thumb { left:3px; }

        /* Mode tabs */
        .tab { padding:6px 18px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s; }
        .tab-active-auto   { background:linear-gradient(90deg,#16a34a,#15803d);color:#fff; }
        .tab-active-manual { background:linear-gradient(90deg,#2563eb,#1d4ed8);color:#fff; }
        .tab-inactive { background:#1e293b;color:#64748b; }

        /* Servo slider */
        input[type=range] { -webkit-appearance:none;width:100%;height:4px;border-radius:2px;background:#334155;outline:none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance:none;width:16px;height:16px;border-radius:8px;background:#8b5cf6;cursor:pointer; }

        /* Sensor bar */
        .sensor-bar-fill { height:5px;border-radius:3px;background:linear-gradient(90deg,#22c55e,#facc15,#ef4444);transition:width .4s; }

        @keyframes slideUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
        .slide-up { animation:slideUp .35s ease forwards; }
        @keyframes ring { 0%{box-shadow:0 0 0 0 #4ade8066} 100%{box-shadow:0 0 0 6px transparent} }

        .btn-press { transition:transform .1s; }
        .btn-press:active { transform:scale(0.95); }
        ::-webkit-scrollbar { width:3px; }
        ::-webkit-scrollbar-thumb { background:#334155;border-radius:2px; }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 pt-6">

<!-- LOGIN MODAL -->
<div id="loginModal" class="fixed inset-0 z-50 flex items-center justify-center p-4"
     style="background:rgba(0,0,0,0.85);backdrop-filter:blur(8px)">
    <div class="glass rounded-2xl p-8 w-full max-w-xs slide-up">
        <div class="text-center mb-7">
            <div class="w-14 h-14 mx-auto mb-4 rounded-full flex items-center justify-center"
                 style="background:linear-gradient(135deg,#3b82f6,#8b5cf6)">
                <i class="fas fa-microchip text-white text-xl"></i>
            </div>
            <h2 class="text-lg font-bold text-white">Pico Servo Controller</h2>
            <p class="text-slate-400 text-xs mt-1">RPi Pico WH · 4 Servo · 4 Ultrasonic</p>
        </div>
        <div class="relative mb-3">
            <i class="fas fa-lock absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-xs"></i>
            <input type="password" id="loginPassword"
                class="w-full pl-9 pr-4 py-3 rounded-xl text-white text-sm tracking-widest focus:outline-none focus:ring-2 focus:ring-blue-500"
                style="background:#1e293b;border:1px solid #334155"
                placeholder="••••••••"
                onkeydown="if(event.key==='Enter') login()">
        </div>
        <p id="loginError" class="text-red-400 text-xs text-center mb-3 hidden">
            <i class="fas fa-exclamation-circle mr-1"></i>รหัสผ่านไม่ถูกต้อง
        </p>
        <button onclick="login()" class="btn-press w-full py-3 rounded-xl font-bold text-white text-sm"
                style="background:linear-gradient(135deg,#3b82f6,#8b5cf6)">เข้าสู่ระบบ</button>
    </div>
</div>

<!-- DASHBOARD -->
<div class="w-full max-w-md slide-up">

    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
        <div>
            <h1 class="text-white font-bold text-base leading-tight">Pico Servo Controller</h1>
            <p class="text-slate-500 text-xs mt-0.5">RPi Pico WH · IoT Dashboard</p>
        </div>
        <div id="statusBadge" class="flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold"
             style="background:#1e293b;border:1px solid #334155;color:#94a3b8">
            <div class="w-2 h-2 rounded-full bg-slate-500"></div><span>–</span>
        </div>
    </div>

    <!-- Mode Tabs -->
    <div class="flex gap-2 mb-4">
        <button id="tabAuto"   onclick="setMode('auto')"
                class="tab tab-inactive flex-1 flex items-center justify-center gap-2">
            <i class="fas fa-robot text-xs"></i> AUTO
        </button>
        <button id="tabManual" onclick="setMode('manual')"
                class="tab tab-inactive flex-1 flex items-center justify-center gap-2">
            <i class="fas fa-hand-paper text-xs"></i> MANUAL
        </button>
    </div>

    <!-- ====== AUTO MODE PANEL ====== -->
    <div id="panelAuto">
        <p class="text-slate-400 text-xs mb-3 px-1">
            <i class="fas fa-info-circle mr-1 text-blue-400"></i>
            ระยะ threshold ต่อ sensor — เมื่อวัดได้ &lt; threshold จะสั่ง Servo ตัวนั้นทำงาน
        </p>
        <div class="grid grid-cols-2 gap-3 mb-4" id="autoSensorGrid"></div>
    </div>

    <!-- ====== MANUAL MODE PANEL ====== -->
    <div id="panelManual" class="hidden">
        <p class="text-slate-400 text-xs mb-3 px-1">
            <i class="fas fa-info-circle mr-1 text-purple-400"></i>
            เปิด/ปิด และกำหนดมุม Servo แต่ละตัวโดยตรง
        </p>
        <div class="space-y-3 mb-4" id="manualServoGrid"></div>
    </div>

    <!-- ====== LIVE SENSORS ====== -->
    <div class="glass-dark rounded-2xl p-4 mb-4">
        <div class="flex items-center gap-2 mb-3">
            <i class="fas fa-satellite-dish text-blue-400 text-xs"></i>
            <span class="text-slate-300 text-xs font-bold uppercase tracking-wider">ค่า Ultrasonic ล่าสุด</span>
        </div>
        <div class="grid grid-cols-4 gap-2" id="liveDistGrid"></div>
    </div>

    <!-- ====== LIVE SERVOS ====== -->
    <div class="glass-dark rounded-2xl p-4 mb-4">
        <div class="flex items-center gap-2 mb-3">
            <i class="fas fa-cog text-purple-400 text-xs"></i>
            <span class="text-slate-300 text-xs font-bold uppercase tracking-wider">สถานะ Servo (มุมจริง)</span>
        </div>
        <div class="grid grid-cols-4 gap-2" id="liveServoGrid"></div>
    </div>

    <!-- Footer -->
    <div class="flex items-center justify-between px-1">
        <p class="text-slate-600 text-[11px]" id="lastUpdate">กำลังเชื่อมต่อ...</p>
        <button onclick="logout()" class="text-slate-600 hover:text-red-400 text-[11px] transition btn-press">
            <i class="fas fa-sign-out-alt mr-1"></i>ออกจากระบบ
        </button>
    </div>
</div>

<script>
// ============================================================
const API_URL    = '/api/device';
let authToken    = sessionStorage.getItem('fan_token');
let pollInterval = null;
let currentMode  = 'auto';
let state        = { device:{mode:'auto'}, sensors:[], servos:[] };
let swingRunning = false, swingTick = 0;

// ============================================================
//  AUTH
// ============================================================
async function login() {
    const pw = document.getElementById('loginPassword').value;
    const errEl = document.getElementById('loginError');
    errEl.classList.add('hidden');
    try {
        const r = await fetch('/api/auth',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:pw})});
        if (r.ok) {
            const {token} = await r.json();
            sessionStorage.setItem('fan_token',token); authToken=token;
            document.getElementById('loginModal').classList.add('hidden');
            startApp();
        } else errEl.classList.remove('hidden');
    } catch { errEl.textContent='เกิดข้อผิดพลาด'; errEl.classList.remove('hidden'); }
}
function logout() {
    sessionStorage.removeItem('fan_token'); authToken=null;
    if (pollInterval) clearInterval(pollInterval);
    document.getElementById('loginModal').classList.remove('hidden');
    document.getElementById('loginPassword').value='';
}
function authHeaders() { return {'Content-Type':'application/json','Authorization':`Bearer ${authToken}`}; }

// ============================================================
//  APP LIFECYCLE
// ============================================================
function startApp() { fetchData(); pollInterval=setInterval(fetchData,2500); }

async function fetchData() {
    try {
        const r = await fetch(API_URL,{headers:{'Authorization':`Bearer ${authToken}`}});
        if (r.status===401) { logout(); return; }
        if (!r.ok) throw new Error();
        const data = await r.json();
        state = data;
        currentMode = data.device?.mode || 'auto';
        renderAll();
        checkOnlineStatus(data.device?.device_last_seen);
    } catch(e) {
        console.error(e);
        setBadge('error');
    }
}

// ============================================================
//  ONLINE BADGE
// ============================================================
function setBadge(type) {
    const b = document.getElementById('statusBadge');
    const styles = {
        online: 'background:#0f2a1a;border:1px solid #166534;color:#4ade80',
        offline:'background:#2d0f0f;border:1px solid #7f1d1d;color:#f87171',
        error:  'background:#2d0f0f;border:1px solid #7f1d1d;color:#f87171',
        waiting:'background:#1e293b;border:1px solid #334155;color:#94a3b8',
    };
    const icons = {
        online: `<div class="w-2 h-2 rounded-full bg-green-500" style="animation:ring 1.5s infinite"></div><span>ออนไลน์</span>`,
        offline:`<div class="w-2 h-2 rounded-full bg-red-500"></div><span>ออฟไลน์</span>`,
        error:  `<div class="w-2 h-2 rounded-full bg-red-500"></div><span>Error</span>`,
        waiting:`<div class="w-2 h-2 rounded-full bg-slate-500"></div><span>รอ...</span>`,
    };
    b.style.cssText = styles[type] || styles.waiting;
    b.innerHTML     = icons[type]  || icons.waiting;
}
function checkOnlineStatus(ts) {
    if (!ts) return setBadge('waiting');
    setBadge((Date.now()-new Date(ts).getTime())/1000 > 15 ? 'offline' : 'online');
}

// ============================================================
//  RENDER ALL
// ============================================================
function renderAll() {
    renderModeTabs();
    renderAutoSensors();
    renderManualServos();
    renderLiveDist();
    renderLiveServos();
    document.getElementById('lastUpdate').innerText = 'อัปเดต: '+new Date().toLocaleTimeString('th-TH');
}

function renderModeTabs() {
    const isAuto = currentMode==='auto';
    document.getElementById('tabAuto').className   = `tab flex-1 flex items-center justify-center gap-2 ${isAuto   ? 'tab-active-auto'   : 'tab-inactive'}`;
    document.getElementById('tabManual').className = `tab flex-1 flex items-center justify-center gap-2 ${!isAuto  ? 'tab-active-manual' : 'tab-inactive'}`;
    document.getElementById('panelAuto').classList.toggle('hidden',   !isAuto);
    document.getElementById('panelManual').classList.toggle('hidden',  isAuto);
}

// ============================================================
//  AUTO PANEL — threshold ต่อ sensor
// ============================================================
function renderAutoSensors() {
    const grid = document.getElementById('autoSensorGrid');
    grid.innerHTML = '';
    (state.sensors||[]).forEach(s => {
        const dist    = s.distance_cm ?? 0;
        const active  = dist > 0 && dist < s.threshold_cm;
        grid.innerHTML += `
        <div class="card-sensor rounded-2xl p-3">
            <div class="flex items-center justify-between mb-2">
                <span class="text-white text-xs font-bold">${s.label}</span>
                <span class="text-[10px] px-1.5 py-0.5 rounded-full font-bold ${active ? 'bg-red-900 text-red-300' : 'bg-slate-800 text-slate-400'}">
                    ${active ? '⚡ TRIGGER' : '✓ OK'}
                </span>
            </div>
            <p class="text-slate-500 text-[9px] mb-2">TRIG GP${s.trig_pin} / ECHO GP${s.echo_pin}</p>
            <label class="text-slate-400 text-[10px]">Threshold (cm)</label>
            <div class="flex items-center gap-2 mt-1">
                <input type="number" id="thr${s.id}" value="${s.threshold_cm}" min="5" max="400" step="5"
                    class="w-full px-2 py-1.5 rounded-lg text-white text-xs focus:outline-none focus:ring-1 focus:ring-blue-500"
                    style="background:#0f172a;border:1px solid #334155">
                <button onclick="saveThreshold(${s.id})" class="btn-press px-2 py-1.5 rounded-lg text-[10px] font-bold text-white"
                        style="background:#2563eb">บันทึก</button>
            </div>
        </div>`;
    });
}

// ============================================================
//  MANUAL PANEL — toggle + angle slider ต่อ servo
// ============================================================
function renderManualServos() {
    const grid = document.getElementById('manualServoGrid');
    grid.innerHTML = '';
    (state.servos||[]).forEach(sv => {
        grid.innerHTML += `
        <div class="card-servo rounded-2xl p-4">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                    <i class="fas fa-cog text-purple-400"></i>
                    <div>
                        <p class="text-white text-sm font-bold">${sv.label}</p>
                        <p class="text-slate-500 text-[10px]">GP${sv.gpio_pin}</p>
                    </div>
                </div>
                <div id="svToggle${sv.id}" onclick="toggleServo(${sv.id})"
                     class="toggle-track ${sv.enabled ? 'on' : 'off'}">
                    <div class="toggle-thumb"></div>
                </div>
            </div>
            <div class="${sv.enabled ? '' : 'opacity-40 pointer-events-none'}">
                <div class="flex justify-between items-center mb-1">
                    <label class="text-slate-400 text-[10px]">มุม (0–180°)</label>
                    <span id="svAngleLbl${sv.id}" class="text-purple-300 text-xs font-bold">${sv.command_angle}°</span>
                </div>
                <input type="range" id="svRange${sv.id}" min="0" max="180" step="5"
                    value="${sv.command_angle}"
                    oninput="document.getElementById('svAngleLbl${sv.id}').textContent=this.value+'°'"
                    onchange="saveServoAngle(${sv.id},this.value)">
                <div class="flex justify-between text-slate-600 text-[9px] mt-0.5">
                    <span>0°</span><span>90°</span><span>180°</span>
                </div>
            </div>
        </div>`;
    });
}

// ============================================================
//  LIVE DISTANCE (small cards)
// ============================================================
function renderLiveDist() {
    const grid = document.getElementById('liveDistGrid');
    grid.innerHTML = '';
    (state.sensors||[]).forEach(s => {
        const d   = s.distance_cm ?? 0;
        const pct = d > 0 ? Math.min(d/400*100,100) : 0;
        const col = d > 0 && d < s.threshold_cm ? '#ef4444' : d > 0 ? '#22c55e' : '#475569';
        grid.innerHTML += `
        <div class="rounded-xl p-2 text-center" style="background:#0f172a;border:1px solid #1e293b">
            <p class="text-[9px] text-slate-500 mb-1">${s.label}</p>
            <p class="text-white font-bold text-sm leading-none" style="color:${col}">${d > 0 ? d+'cm' : '–'}</p>
            <div class="mt-1.5 rounded-full overflow-hidden" style="height:4px;background:#1e293b">
                <div class="sensor-bar-fill" style="width:${pct}%"></div>
            </div>
        </div>`;
    });
}

// ============================================================
//  LIVE SERVO ANGLES (needle SVG)
// ============================================================
function renderLiveServos() {
    const grid = document.getElementById('liveServoGrid');
    grid.innerHTML = '';
    (state.servos||[]).forEach(sv => {
        grid.innerHTML += `
        <div class="rounded-xl p-2 text-center" style="background:#0f172a;border:1px solid #1e293b">
            <svg width="40" height="40" viewBox="0 0 40 40" class="mx-auto mb-0.5">
                <circle cx="20" cy="20" r="14" fill="none" stroke="#1e293b" stroke-width="2.5"/>
                <line x1="20" y1="20"
                      x2="${20+14*Math.sin((sv.angle-90)*Math.PI/180)}"
                      y2="${20-14*Math.cos((sv.angle-90)*Math.PI/180)}"
                      stroke="#a78bfa" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <p class="text-purple-300 font-bold text-xs leading-none">${sv.angle}°</p>
            <p class="text-[9px] text-slate-600 mt-0.5">GP${sv.gpio_pin}</p>
        </div>`;
    });
}

// ============================================================
//  COMMANDS
// ============================================================
async function apiPost(action, payload) {
    const r = await fetch(API_URL,{
        method:'POST', headers:authHeaders(),
        body:JSON.stringify({from_app:true, action, payload})
    });
    if (r.status===401) { logout(); return false; }
    return r.ok;
}

async function setMode(mode) {
    if (mode === currentMode) return;
    currentMode = mode;
    renderModeTabs(); // อัปเดต UI ทันที
    await apiPost('set_mode', mode);
    fetchData();
}

async function saveThreshold(sensorId) {
    const val = parseFloat(document.getElementById(`thr${sensorId}`).value);
    if (isNaN(val) || val < 5) return;
    await apiPost('set_threshold',{ id:sensorId, threshold_cm:val });
    fetchData();
}

async function toggleServo(servoId) {
    const sv = state.servos.find(s=>s.id===servoId);
    if (!sv) return;
    await apiPost('set_servo',{ id:servoId, enabled:!sv.enabled });
    fetchData();
}

async function saveServoAngle(servoId, angle) {
    await apiPost('set_servo',{ id:servoId, command_angle:parseInt(angle) });
    fetchData();
}

// ============================================================
//  BOOT
// ============================================================
if (authToken) {
    document.getElementById('loginModal').classList.add('hidden');
    startApp();
}
</script>
</body>
</html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pico Servo Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #0f172a; font-family: 'Segoe UI', sans-serif; }

        .glass {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(12px);
        }
        .glass-dark {
            background: rgba(0,0,0,0.25);
            border: 1px solid rgba(255,255,255,0.07);
        }

        /* Gradient glow cards */
        .card-swing  { background: linear-gradient(135deg,#2d1b69 0%,#1a0f3d 100%); border:1px solid #7c3aed44; }
        .card-motion { background: linear-gradient(135deg,#3a2a0e 0%,#281e08 100%); border:1px solid #d9770644; }

        /* Toggle switch */
        .toggle-track {
            width:52px; height:28px; border-radius:14px; position:relative;
            cursor:pointer; transition:background .3s;
        }
        .toggle-track.on  { background: #22c55e; }
        .toggle-track.off { background: #475569; }
        .toggle-thumb {
            width:22px; height:22px; border-radius:11px; background:#fff;
            position:absolute; top:3px; transition:left .3s; box-shadow:0 1px 4px #0008;
        }
        .toggle-track.on  .toggle-thumb { left:27px; }
        .toggle-track.off .toggle-thumb { left:3px; }

        /* Sensor bar */
        .sensor-bar-fill {
            height:6px; border-radius:3px;
            background: linear-gradient(90deg,#22c55e,#facc15,#ef4444);
            transition: width .4s ease;
        }

        /* Pulse ring for online status */
        @keyframes ring { 0%{transform:scale(1);opacity:.8} 100%{transform:scale(2.2);opacity:0} }
        .ring-anim { animation: ring 1.5s ease-out infinite; }

        /* Mode pill */
        .mode-auto   { background: linear-gradient(90deg,#16a34a,#15803d); }
        .mode-manual { background: linear-gradient(90deg,#2563eb,#1d4ed8); }

        /* Slide in */
        @keyframes slideUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
        .slide-up { animation: slideUp .4s ease forwards; }

        input[type=number]::-webkit-inner-spin-button { -webkit-appearance:none; }
        input[type=number] { -moz-appearance:textfield; }

        .btn-press { transition: transform .1s, box-shadow .1s; }
        .btn-press:active { transform:scale(0.95); }

        ::-webkit-scrollbar { width:4px; }
        ::-webkit-scrollbar-track { background:transparent; }
        ::-webkit-scrollbar-thumb { background:#334155; border-radius:2px; }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 pt-6">

<!-- ======== LOGIN MODAL ======== -->
<div id="loginModal" class="fixed inset-0 z-50 flex items-center justify-center p-4"
     style="background:rgba(0,0,0,0.85);backdrop-filter:blur(8px)">
    <div class="glass rounded-2xl p-8 w-full max-w-xs slide-up">
        <div class="text-center mb-7">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center"
                 style="background:linear-gradient(135deg,#3b82f6,#8b5cf6)">
                <i class="fas fa-microchip text-white text-2xl"></i>
            </div>
            <h2 class="text-xl font-bold text-white">Pico Servo Controller</h2>
            <p class="text-slate-400 text-sm mt-1">RPi Pico WH · 4 Servo · 4 Ultrasonic</p>
        </div>
        <div class="relative mb-3">
            <i class="fas fa-lock absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-sm"></i>
            <input type="password" id="loginPassword"
                class="w-full pl-9 pr-4 py-3 rounded-xl text-white text-sm tracking-widest focus:outline-none focus:ring-2 focus:ring-blue-500"
                style="background:#1e293b;border:1px solid #334155"
                placeholder="••••••••"
                onkeydown="if(event.key==='Enter') login()">
        </div>
        <p id="loginError" class="text-red-400 text-xs text-center mb-3 hidden">
            <i class="fas fa-exclamation-circle mr-1"></i>รหัสผ่านไม่ถูกต้อง
        </p>
        <button onclick="login()" class="btn-press w-full py-3 rounded-xl font-bold text-white text-sm shadow-lg"
                style="background:linear-gradient(135deg,#3b82f6,#8b5cf6)">
            เข้าสู่ระบบ
        </button>
    </div>
</div>

<!-- ======== MAIN DASHBOARD ======== -->
<div class="w-full max-w-md slide-up">

    <!-- Header -->
    <div class="flex items-center justify-between mb-5">
        <div>
            <h1 class="text-white font-bold text-lg leading-tight">Pico Servo Controller</h1>
            <p class="text-slate-500 text-xs mt-0.5">RPi Pico WH · IoT Dashboard</p>
        </div>
        <div class="flex items-center gap-3">
            <!-- Device selector -->
            <select id="deviceSelect" onchange="changeDevice()"
                class="text-white text-xs font-bold px-3 py-1.5 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500"
                style="background:#1e293b;border:1px solid #334155">
                <option value="1">พัดลม 1</option>
                <option value="2">พัดลม 2</option>
            </select>
            <!-- Online badge -->
            <div id="statusBadge" class="flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold"
                 style="background:#1e293b;border:1px solid #334155;color:#94a3b8">
                <div class="w-2 h-2 rounded-full bg-slate-500"></div>
                <span>–</span>
            </div>
        </div>
    </div>

    <!-- Motion Status Banner -->
    <div class="card-motion rounded-2xl p-4 mb-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <i class="fas fa-satellite-dish text-yellow-400 text-xl"></i>
            <div>
                <p class="text-slate-400 text-xs mb-0.5">สถานะ Ultrasonic</p>
                <div id="motionBig" class="text-xl font-bold text-white leading-none">--</div>
            </div>
        </div>
        <p id="motionSub" class="text-slate-500 text-xs">ไม่มีการเคลื่อนไหว</p>
    </div>

    <!-- Ultrasonic Sensor Distances -->
    <div class="glass-dark rounded-2xl p-4 mb-4">
        <div class="flex items-center gap-2 mb-3">
            <i class="fas fa-radar text-blue-400 text-xs"></i>
            <span class="text-slate-300 text-xs font-bold uppercase tracking-wider">Ultrasonic Sensors (HC-SR04)</span>
        </div>
        <div class="grid grid-cols-2 gap-3" id="sensorGrid">
            <!-- Sensor cards generated by JS -->
        </div>
    </div>

    <!-- Servo Status + Controls -->
    <div class="glass-dark rounded-2xl p-4 mb-4">
        <div class="flex items-center gap-2 mb-3">
            <i class="fas fa-cog text-purple-400 text-xs"></i>
            <span class="text-slate-300 text-xs font-bold uppercase tracking-wider">Servo Control (GP2–GP5)</span>
        </div>
        <div class="grid grid-cols-4 gap-2 mb-4" id="servoGrid">
            <!-- Servo indicators generated by JS -->
        </div>

        <!-- Swing Toggle (full width) -->
        <div id="manualControls" class="transition duration-300">
            <div class="card-swing rounded-xl p-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i id="swingIcon" class="fas fa-arrows-alt-h text-purple-400 text-2xl"></i>
                    <div>
                        <p class="text-white text-sm font-bold">ส่าย (Servo 2–4)</p>
                        <p id="swingStatus" class="text-purple-300 text-xs mt-0.5">หยุดอยู่</p>
                    </div>
                </div>
                <div id="toggleSwingTrack" onclick="toggleSwing()" class="toggle-track off">
                    <div class="toggle-thumb"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="flex items-center justify-between px-1">
        <p class="text-slate-600 text-[11px]" id="lastUpdate">กำลังเชื่อมต่อ...</p>
        <button onclick="logout()" class="text-slate-600 hover:text-red-400 text-[11px] transition btn-press">
            <i class="fas fa-sign-out-alt mr-1"></i>ออกจากระบบ
        </button>
    </div>
</div>

<script>
    // ============================================================
    //  CONFIG
    // ============================================================
    const API_URL = '/api/device?id=1';
    let state = { manual_mode: false, swing_command: false };
    let authToken   = sessionStorage.getItem('fan_token');
    let pollInterval = null;

    // ============================================================
    //  INIT GRIDS
    // ============================================================
    function initGrids() {
        // Sensor grid
        const sg = document.getElementById('sensorGrid');
        sg.innerHTML = '';
        for (let i = 0; i < 4; i++) {
            sg.innerHTML += `
            <div class="rounded-xl p-2.5" style="background:#0f172a;border:1px solid #1e293b">
                <div class="flex items-center justify-between mb-1.5">
                    <span class="text-slate-400 text-[10px] font-bold">S${i+1}</span>
                    <span class="text-[10px] font-bold" id="sDot${i}">●</span>
                </div>
                <p class="text-white font-bold text-base leading-none" id="sDist${i}">– cm</p>
                <div class="mt-2 rounded-full overflow-hidden" style="height:5px;background:#1e293b">
                    <div class="sensor-bar-fill" id="sBar${i}" style="width:0%"></div>
                </div>
                <p class="text-slate-600 text-[9px] mt-1">GP${6+i*2}/GP${7+i*2}</p>
            </div>`;
        }

        // Servo grid
        const srv = document.getElementById('servoGrid');
        srv.innerHTML = '';
        const labels = ['Servo 1','Servo 2','Servo 3','Servo 4'];
        const gpins  = [2,3,4,5];
        for (let i = 0; i < 4; i++) {
            srv.innerHTML += `
            <div class="rounded-xl p-2 text-center" style="background:#0f172a;border:1px solid #1e293b">
                <div class="servo-arc mx-auto mb-1 flex items-center justify-center relative">
                    <svg width="48" height="48" viewBox="0 0 48 48">
                        <circle cx="24" cy="24" r="18" fill="none" stroke="#1e293b" stroke-width="3"/>
                        <path id="srvArc${i}" d="" fill="none" stroke="#334155" stroke-width="3" stroke-linecap="round"/>
                        <line id="srvNeedle${i}" x1="24" y1="24" x2="24" y2="8"
                              stroke="#60a5fa" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </div>
                <p class="text-[9px] text-slate-400">${labels[i]}</p>
                <p class="text-[9px] text-slate-600">GP${gpins[i]}</p>
            </div>`;
        }
    }

    function setServoAngle(i, angle) {
        const needle = document.getElementById(`srvNeedle${i}`);
        if (!needle) return;
        const r = 16, rad = (angle - 90) * Math.PI / 180;
        needle.setAttribute('x2', 24 + r * Math.sin(rad));
        needle.setAttribute('y2', 24 - r * Math.cos(rad));
    }

    function updateSensorUI(index, distCm) {
        const dot  = document.getElementById(`sDot${index}`);
        const disp = document.getElementById(`sDist${index}`);
        const bar  = document.getElementById(`sBar${index}`);
        if (!dot) return;
        const MAX_CM = 200;
        if (distCm <= 0) {
            dot.style.color = '#475569';
            disp.textContent = '– cm';
            bar.style.width = '0%';
        } else {
            const pct = Math.min(distCm / MAX_CM * 100, 100);
            bar.style.width = pct + '%';
            disp.textContent = distCm.toFixed(0) + ' cm';
            dot.style.color = distCm < 50 ? '#ef4444' : distCm < 100 ? '#facc15' : '#22c55e';
        }
    }

    // ============================================================
    //  AUTH
    // ============================================================
    async function login() {
        const pw = document.getElementById('loginPassword').value;
        const errEl = document.getElementById('loginError');
        errEl.classList.add('hidden');
        try {
            const res = await fetch('/api/auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: pw })
            });
            if (res.ok) {
                const { token } = await res.json();
                sessionStorage.setItem('fan_token', token);
                authToken = token;
                document.getElementById('loginModal').classList.add('hidden');
                startApp();
            } else {
                errEl.classList.remove('hidden');
            }
        } catch {
            errEl.textContent = 'เกิดข้อผิดพลาด ลองใหม่';
            errEl.classList.remove('hidden');
        }
    }

    function logout() {
        sessionStorage.removeItem('fan_token');
        authToken = null;
        if (pollInterval) clearInterval(pollInterval);
        document.getElementById('loginModal').classList.remove('hidden');
        document.getElementById('loginPassword').value = '';
    }

    function getAuthHeaders() {
        return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` };
    }

    // ============================================================
    //  APP LIFECYCLE
    // ============================================================
    function startApp() {
        initGrids();
        fetchData();
        pollInterval = setInterval(fetchData, 2000);
    }

    // ============================================================
    //  FETCH + UPDATE UI
    // ============================================================
    async function fetchData() {
        try {
            const res = await fetch(API_URL, { headers: { 'Authorization': `Bearer ${authToken}` } });
            if (res.status === 401) { logout(); return; }
            if (!res.ok) throw new Error('API Error');
            const data = await res.json();
            state = data;
            updateUI(data);
            checkOnlineStatus(data.device_last_seen);
        } catch (e) {
            console.error(e);
            const badge = document.getElementById('statusBadge');
            badge.style.borderColor = '#7f1d1d44';
            badge.innerHTML = '<div class="w-2 h-2 rounded-full bg-red-500"></div><span class="text-red-400">Error</span>';
        }
    }

    function checkOnlineStatus(lastSeenStr) {
        const badge = document.getElementById('statusBadge');
        if (!lastSeenStr) {
            badge.style.cssText = 'background:#1e293b;border:1px solid #334155;color:#94a3b8';
            badge.innerHTML = '<div class="w-2 h-2 rounded-full bg-slate-500"></div><span>ไม่เคยออนไลน์</span>';
            return;
        }
        const diff = (Date.now() - new Date(lastSeenStr).getTime()) / 1000;
        if (diff > 15) {
            badge.style.cssText = 'background:#2d0f0f;border:1px solid #7f1d1d;color:#f87171';
            badge.innerHTML = '<div class="w-2 h-2 rounded-full bg-red-500 ring-anim"></div><span>ออฟไลน์</span>';
        } else {
            badge.style.cssText = 'background:#0f2a1a;border:1px solid #166534;color:#4ade80';
            badge.innerHTML = '<div class="w-2 h-2 rounded-full bg-green-500" style="animation:ring 1.5s ease-out infinite;box-shadow:0 0 0 0 #4ade8066"></div><span>ออนไลน์</span>';
        }
    }

    function updateUI(data) {
        // Motion
        const motionBig = document.getElementById('motionBig');
        const motionSub = document.getElementById('motionSub');
        if (data.motion_detected) {
            motionBig.innerHTML   = '<span class="text-red-400">⚡ เจอ!</span>';
            motionSub.textContent = 'ตรวจพบการเคลื่อนไหว';
            motionSub.className   = 'text-red-400 text-xs animate-pulse';
        } else {
            motionBig.innerHTML   = '<span class="text-green-400">✓ ว่าง</span>';
            motionSub.textContent = 'ไม่มีการเคลื่อนไหว';
            motionSub.className   = 'text-slate-500 text-xs';
        }

        // Sensor bars — ค่าจริงจาก device (ถ้ามี) หรือ simulate
        const dist = data.motion_detected
            ? [Math.random()*60+10, Math.random()*80+20, Math.random()*50+30, Math.random()*70+15]
            : [0, 0, 0, 0];
        for (let i = 0; i < 4; i++) updateSensorUI(i, dist[i]);

        // Servo 1 ตาม motion (AUTO: หมุนเมื่อมีคน)
        setServoAngle(0, data.motion_detected ? 180 : 90);

        // Swing toggle
        const swingTrack = document.getElementById('toggleSwingTrack');
        const swingIcon  = document.getElementById('swingIcon');
        const swingSt    = document.getElementById('swingStatus');
        if (data.swing_command) {
            swingTrack.className = 'toggle-track on';
            swingIcon.className  = 'fas fa-arrows-alt-h text-purple-400 text-2xl';
            swingSt.textContent  = 'กำลังส่าย...';
            animateSwing(true);
        } else {
            swingTrack.className = 'toggle-track off';
            swingIcon.className  = 'fas fa-arrows-alt-h text-slate-500 text-2xl';
            swingSt.textContent  = 'หยุดอยู่';
            animateSwing(false);
            setServoAngle(1, 90); setServoAngle(2, 90); setServoAngle(3, 90);
        }

        document.getElementById('lastUpdate').innerText = 'อัปเดต: ' + new Date().toLocaleTimeString('th-TH');
    }

    // ============================================================
    //  Servo Swing Animation (visual only)
    // ============================================================
    let swingRunning = false;
    let swingTick = 0;
    function animateSwing(enable) {
        if (enable && !swingRunning) {
            swingRunning = true;
            (function tick() {
                if (!swingRunning) return;
                swingTick += 2;
                const a = 90 + 45 * Math.sin(swingTick * Math.PI / 180);
                setServoAngle(1, a); setServoAngle(2, a); setServoAngle(3, a);
                requestAnimationFrame(tick);
            })();
        } else if (!enable) {
            swingRunning = false;
        }
    }

    // ============================================================
    //  COMMANDS
    // ============================================================
    async function sendCommand(swing) {
        state.swing_command = swing;
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify({ from_app: true, swing_command: swing })
        });
        if (res.status === 401) { logout(); return; }
        fetchData();
    }

    function toggleSwing() { sendCommand(!state.swing_command); }

    // ============================================================
    //  BOOT
    // ============================================================
    if (authToken) {
        document.getElementById('loginModal').classList.add('hidden');
        startApp();
    }
</script>
</body>
</html>