<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Trash Bin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap');
    body{font-family:'Noto Sans Thai',sans-serif}
    .bin-card{transition:all .3s ease}
    .bin-card:hover{transform:translateY(-4px)}
    .lid-open{animation:pulse-g 1.5s infinite}
    @keyframes pulse-g{0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,.4)}50%{box-shadow:0 0 0 12px rgba(34,197,94,0)}}
    .toggle{position:relative;width:52px;height:28px;background:#4b5563;border-radius:14px;cursor:pointer;transition:background .3s}
    .toggle.on{background:#3b82f6}
    .toggle::after{content:'';position:absolute;top:2px;left:2px;width:24px;height:24px;background:#fff;border-radius:50%;transition:transform .3s}
    .toggle.on::after{transform:translateX(24px)}
    .dist-bar{height:6px;border-radius:3px;background:#374151;overflow:hidden}
    .dist-fill{height:100%;border-radius:3px;transition:width .5s,background .5s}
    .log-row{animation:fadeIn .3s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body class="bg-gray-950 text-white min-h-screen">

<!--  LOGIN SCREEN  -->
<div id="loginScreen" class="flex items-center justify-center min-h-screen">
  <div class="bg-gray-900 border border-gray-700 rounded-2xl p-8 w-full max-w-sm shadow-2xl">
    <div class="text-center mb-6">
      <span class="text-5xl">ğŸ—‘ï¸</span>
      <h1 class="text-xl font-bold mt-3">Smart Trash Bin</h1>
      <p class="text-gray-400 text-sm">à¸£à¸°à¸šà¸šà¸–à¸±à¸‡à¸‚à¸¢à¸°à¸­à¸±à¸ˆà¸‰à¸£à¸´à¸¢à¸° 4 à¹ƒà¸š</p>
    </div>
    <input id="pwdInput" type="password" placeholder="à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™"
      class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-xl text-center focus:outline-none focus:border-blue-500 mb-4">
    <button onclick="login()" id="loginBtn"
      class="w-full py-3 bg-blue-600 hover:bg-blue-700 rounded-xl font-semibold transition">à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š</button>
    <p id="loginErr" class="text-red-400 text-sm text-center mt-3 hidden"></p>
  </div>
</div>

<!--  DASHBOARD  -->
<div id="dashboard" class="hidden">

  <!-- Header -->
  <header class="bg-gray-900 border-b border-gray-800 px-4 py-3 sticky top-0 z-30">
    <div class="max-w-7xl mx-auto flex items-center justify-between flex-wrap gap-2">
      <div class="flex items-center gap-2">
        <span class="text-2xl">ğŸ—‘ï¸</span>
        <div>
          <h1 class="text-lg font-bold leading-tight">Smart Trash Bin</h1>
          <p class="text-gray-500 text-xs">à¸–à¸±à¸‡à¸‚à¸¢à¸°à¸­à¸±à¸ˆà¸‰à¸£à¸´à¸¢à¸° 4 à¹ƒà¸š &mdash; Pico WH</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span class="flex items-center gap-1.5">
          <span id="dot" class="w-2.5 h-2.5 rounded-full bg-gray-600"></span>
          <span id="dotTxt" class="text-xs text-gray-500">-</span>
        </span>
        <button onclick="setAllMode('auto')"
          class="px-3 py-1.5 bg-green-600 hover:bg-green-700 rounded-lg text-xs font-semibold transition">ğŸ¤– Auto à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</button>
        <button onclick="setAllMode('manual')"
          class="px-3 py-1.5 bg-orange-500 hover:bg-orange-600 rounded-lg text-xs font-semibold transition">ğŸ® Manual à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</button>
        <button onclick="logout()"
          class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded-lg text-xs transition">à¸­à¸­à¸</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-4 md:p-6">

    <!-- Bin Cards -->
    <div id="binCards" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-5 mb-8"></div>

    <!-- Logs -->
    <div class="bg-gray-900 rounded-2xl p-5 border border-gray-800">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold text-sm flex items-center gap-1.5">ğŸ“‹ à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™</h2>
        <button onclick="refresh()" class="text-xs px-2.5 py-1 bg-gray-800 hover:bg-gray-700 rounded-lg transition">ğŸ”„ à¸£à¸µà¹€à¸Ÿà¸£à¸Š</button>
      </div>
      <div id="logList" class="space-y-1.5 max-h-60 overflow-y-auto text-sm"></div>
    </div>
  </main>
</div>

<script>
/* â”€â”€ Config â”€â”€ */
const API = '/api';
const COLORS = ['#3b82f6','#22c55e','#ef4444','#f59e0b'];
const EMOJI  = ['ğŸ—‘ï¸','â™»ï¸','â˜£ï¸','ğŸ‚'];
const ACT_LBL = {
  lid_opened:'ğŸ”“ à¹€à¸›à¸´à¸”à¸à¸²', lid_closed:'ğŸ”’ à¸›à¸´à¸”à¸à¸²',
  mode_changed:'âš™ï¸ à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹‚à¸«à¸¡à¸”', threshold_changed:'ğŸ“ à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸£à¸°à¸¢à¸°',
  manual_open:'ğŸ® à¹€à¸›à¸´à¸”à¸à¸² (Manual)', manual_close:'ğŸ® à¸›à¸´à¸”à¸à¸² (Manual)',
};
let token = localStorage.getItem('token');
let refreshTimer, logTimer;

/* â”€â”€ Auth â”€â”€ */
async function login(){
  const pwd = document.getElementById('pwdInput').value.trim();
  const errEl = document.getElementById('loginErr');
  errEl.classList.add('hidden');
  if(!pwd) return;
  try{
    const r = await fetch(`${API}/auth`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:pwd})});
    const d = await r.json();
    if(!r.ok){ errEl.textContent = d.error||'à¸œà¸´à¸”à¸à¸¥à¸²à¸”'; errEl.classList.remove('hidden'); return; }
    token = d.token; localStorage.setItem('token',token);
    showDashboard();
  }catch(e){ errEl.textContent='à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¹„à¸¡à¹ˆà¹„à¸”à¹‰'; errEl.classList.remove('hidden'); }
}
document.getElementById('pwdInput').addEventListener('keydown',e=>{ if(e.key==='Enter') login(); });

function logout(){ token=null; localStorage.removeItem('token'); clearInterval(refreshTimer); clearInterval(logTimer); location.reload(); }

function showDashboard(){
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  refresh();
  refreshTimer = setInterval(refresh, 1500);
}

/* â”€â”€ Fetch helpers â”€â”€ */
function authHeaders(){ return {'Content-Type':'application/json','Authorization':'Bearer '+token}; }

async function refresh(){
  try{
    const r = await fetch(`${API}/device`,{headers:authHeaders()});
    if(r.status===401){ logout(); return; }
    const d = await r.json();
    renderBins(d.bins||[]);
    renderLogs(d.logs||[]);
    setConn(true);
  }catch{ setConn(false); }
}

async function apiPost(action, payload){
  await fetch(`${API}/device`,{method:'POST',headers:authHeaders(),body:JSON.stringify({from_app:true,action,payload})});
  refresh();
}

/* â”€â”€ Actions â”€â”€ */
function toggleMode(id, cur){ apiPost('set_mode',{id, mode: cur==='auto'?'manual':'auto'}); }
function setThreshold(id, val){ apiPost('set_threshold',{id, threshold_cm: parseFloat(val)}); }
function manualLid(id, open){ apiPost('manual_lid',{id, open}); }
function setAllMode(m){ apiPost('set_all_mode', m); }

/* â”€â”€ Connection dot â”€â”€ */
function setConn(ok){
  document.getElementById('dot').className = 'w-2.5 h-2.5 rounded-full '+(ok?'bg-green-500':'bg-red-500');
  document.getElementById('dotTxt').textContent = ok?'à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¹à¸¥à¹‰à¸§':'à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­';
}

/* â”€â”€ Render Bins â”€â”€ */
function renderBins(bins){
  const c = document.getElementById('binCards');
  c.innerHTML = bins.map((b,i)=>{
    const col = COLORS[i]||COLORS[0];
    const emo = EMOJI[i]||'ğŸ—‘ï¸';
    const isOpen = b.lid_status==='open';
    const isMan  = b.mode==='manual';
    const manOn  = b.manual_open;

    // distance bar
    const pct = Math.min(100, Math.max(0, (b.distance_cm/200)*100));
    let dCol = '#22c55e';
    if(b.distance_cm < b.threshold_cm) dCol='#ef4444';
    else if(b.distance_cm < b.threshold_cm*1.5) dCol='#f59e0b';

    // device online check (seen within 10s)
    const seen = b.device_last_seen ? (Date.now()-new Date(b.device_last_seen).getTime())/1000 : 9999;
    const online = seen < 10;

    return `
    <div class="bin-card bg-gray-900 rounded-2xl p-5 border border-gray-800 ${isOpen?'lid-open':''}" style="border-top:3px solid ${col}">
      <!-- hdr -->
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
          <span class="text-3xl ${isOpen?'rotate-[-12deg] scale-110':''} transition-transform">${emo}</span>
          <div>
            <h3 class="font-semibold text-sm">${b.name}</h3>
            <span class="text-[10px] px-1.5 py-0.5 rounded-full ${isOpen?'bg-green-500/20 text-green-400':'bg-gray-700 text-gray-400'}">${isOpen?'ğŸ”“ à¹€à¸›à¸´à¸”':'ğŸ”’ à¸›à¸´à¸”'}</span>
            <span class="text-[10px] px-1.5 py-0.5 rounded-full ${online?'bg-blue-500/20 text-blue-400':'bg-red-500/20 text-red-400'} ml-1">${online?'â— online':'â—‹ offline'}</span>
          </div>
        </div>
        <span class="text-2xl font-black" style="color:${col}">#${b.id}</span>
      </div>

      <!-- distance -->
      <div class="mb-3">
        <div class="flex justify-between text-xs mb-1">
          <span class="text-gray-400">à¸£à¸°à¸¢à¸°à¸—à¸²à¸‡</span>
          <span class="font-mono font-bold" style="color:${dCol}">${b.distance_cm>=999?'---':b.distance_cm.toFixed(1)} cm</span>
        </div>
        <div class="dist-bar"><div class="dist-fill" style="width:${100-pct}%;background:${dCol}"></div></div>
      </div>

      <!-- mode toggle -->
      <div class="flex items-center justify-between mb-3 p-2.5 bg-gray-800/60 rounded-xl">
        <div>
          <div class="text-xs font-semibold">${isMan?'ğŸ® Manual':'ğŸ¤– Auto'}</div>
          <div class="text-[10px] text-gray-500">à¹‚à¸«à¸¡à¸”à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™</div>
        </div>
        <div class="toggle ${isMan?'on':''}" onclick="toggleMode(${b.id},'${b.mode}')"></div>
      </div>

      <!-- threshold -->
      <div class="mb-3 p-2.5 bg-gray-800/60 rounded-xl ${isMan?'opacity-40 pointer-events-none':''}">
        <div class="flex justify-between text-xs mb-1.5">
          <span class="text-gray-400">ğŸ“ à¸£à¸°à¸¢à¸°à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸š</span>
          <span class="font-mono font-bold" id="thVal${b.id}">${b.threshold_cm} cm</span>
        </div>
        <input type="range" min="5" max="100" step="1" value="${b.threshold_cm}"
          class="w-full accent-blue-500 cursor-pointer"
          oninput="document.getElementById('thVal${b.id}').textContent=this.value+' cm'"
          onchange="setThreshold(${b.id},this.value)">
      </div>

      <!-- manual buttons -->
      <div class="grid grid-cols-2 gap-2 ${!isMan?'opacity-40 pointer-events-none':''}">
        <button onclick="manualLid(${b.id},true)"
          class="py-2 rounded-xl text-xs font-semibold transition ${manOn?'bg-green-600 text-white':'bg-gray-800 text-gray-400 hover:bg-green-600 hover:text-white'}">ğŸ”“ à¹€à¸›à¸´à¸”à¸à¸²</button>
        <button onclick="manualLid(${b.id},false)"
          class="py-2 rounded-xl text-xs font-semibold transition ${!manOn?'bg-red-600 text-white':'bg-gray-800 text-gray-400 hover:bg-red-600 hover:text-white'}">ğŸ”’ à¸›à¸´à¸”à¸à¸²</button>
      </div>
    </div>`;
  }).join('');
}

/* â”€â”€ Render Logs â”€â”€ */
function renderLogs(logs){
  const c = document.getElementById('logList');
  if(!logs.length){ c.innerHTML='<p class="text-gray-600 text-center py-3">à¹„à¸¡à¹ˆà¸¡à¸µà¸›à¸£à¸°à¸§à¸±à¸•à¸´</p>'; return; }
  c.innerHTML = logs.map(l=>{
    const t = new Date(l.created_at).toLocaleString('th-TH',{hour:'2-digit',minute:'2-digit',second:'2-digit',day:'2-digit',month:'short'});
    const lbl = ACT_LBL[l.action]||l.action;
    return `<div class="log-row flex items-center justify-between px-3 py-1.5 bg-gray-800/40 rounded-lg">
      <div class="flex items-center gap-2 flex-wrap">
        <span class="text-xs">${lbl}</span>
        <span class="text-[10px] text-gray-500">à¸–à¸±à¸‡ #${l.bin_id}</span>
        ${l.detail?`<span class="text-[10px] text-gray-600">(${l.detail})</span>`:''}
      </div>
      <span class="text-[10px] text-gray-600 whitespace-nowrap">${t}</span>
    </div>`;
  }).join('');
}

/* â”€â”€ Init â”€â”€ */
if(token) showDashboard();
</script>
</body>
</html>
