<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pico Servo Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #0f172a; font-family: 'Segoe UI', sans-serif; }

        .glass {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(12px);
        }
        .glass-dark {
            background: rgba(0,0,0,0.25);
            border: 1px solid rgba(255,255,255,0.07);
        }

        /* Gradient glow cards */
        .card-swing  { background: linear-gradient(135deg,#2d1b69 0%,#1a0f3d 100%); border:1px solid #7c3aed44; }
        .card-motion { background: linear-gradient(135deg,#3a2a0e 0%,#281e08 100%); border:1px solid #d9770644; }

        /* Toggle switch */
        .toggle-track {
            width:52px; height:28px; border-radius:14px; position:relative;
            cursor:pointer; transition:background .3s;
        }
        .toggle-track.on  { background: #22c55e; }
        .toggle-track.off { background: #475569; }
        .toggle-thumb {
            width:22px; height:22px; border-radius:11px; background:#fff;
            position:absolute; top:3px; transition:left .3s; box-shadow:0 1px 4px #0008;
        }
        .toggle-track.on  .toggle-thumb { left:27px; }
        .toggle-track.off .toggle-thumb { left:3px; }

        /* Sensor bar */
        .sensor-bar-fill {
            height:6px; border-radius:3px;
            background: linear-gradient(90deg,#22c55e,#facc15,#ef4444);
            transition: width .4s ease;
        }

        /* Pulse ring for online status */
        @keyframes ring { 0%{transform:scale(1);opacity:.8} 100%{transform:scale(2.2);opacity:0} }
        .ring-anim { animation: ring 1.5s ease-out infinite; }

        /* Mode pill */
        .mode-auto   { background: linear-gradient(90deg,#16a34a,#15803d); }
        .mode-manual { background: linear-gradient(90deg,#2563eb,#1d4ed8); }

        /* Slide in */
        @keyframes slideUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
        .slide-up { animation: slideUp .4s ease forwards; }

        input[type=number]::-webkit-inner-spin-button { -webkit-appearance:none; }
        input[type=number] { -moz-appearance:textfield; }

        .btn-press { transition: transform .1s, box-shadow .1s; }
        .btn-press:active { transform:scale(0.95); }

        ::-webkit-scrollbar { width:4px; }
        ::-webkit-scrollbar-track { background:transparent; }
        ::-webkit-scrollbar-thumb { background:#334155; border-radius:2px; }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 pt-6">

<!-- ======== LOGIN MODAL ======== -->
<div id="loginModal" class="fixed inset-0 z-50 flex items-center justify-center p-4"
     style="background:rgba(0,0,0,0.85);backdrop-filter:blur(8px)">
    <div class="glass rounded-2xl p-8 w-full max-w-xs slide-up">
        <div class="text-center mb-7">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center"
                 style="background:linear-gradient(135deg,#3b82f6,#8b5cf6)">
                <i class="fas fa-microchip text-white text-2xl"></i>
            </div>
            <h2 class="text-xl font-bold text-white">Pico Servo Controller</h2>
            <p class="text-slate-400 text-sm mt-1">RPi Pico WH · 4 Servo · 4 Ultrasonic</p>
        </div>
        <div class="relative mb-3">
            <i class="fas fa-lock absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-sm"></i>
            <input type="password" id="loginPassword"
                class="w-full pl-9 pr-4 py-3 rounded-xl text-white text-sm tracking-widest focus:outline-none focus:ring-2 focus:ring-blue-500"
                style="background:#1e293b;border:1px solid #334155"
                placeholder="••••••••"
                onkeydown="if(event.key==='Enter') login()">
        </div>
        <p id="loginError" class="text-red-400 text-xs text-center mb-3 hidden">
            <i class="fas fa-exclamation-circle mr-1"></i>รหัสผ่านไม่ถูกต้อง
        </p>
        <button onclick="login()" class="btn-press w-full py-3 rounded-xl font-bold text-white text-sm shadow-lg"
                style="background:linear-gradient(135deg,#3b82f6,#8b5cf6)">
            เข้าสู่ระบบ
        </button>
    </div>
</div>

<!-- ======== MAIN DASHBOARD ======== -->
<div class="w-full max-w-md slide-up">

    <!-- Header -->
    <div class="flex items-center justify-between mb-5">
        <div>
            <h1 class="text-white font-bold text-lg leading-tight">Pico Servo Controller</h1>
            <p class="text-slate-500 text-xs mt-0.5">RPi Pico WH · IoT Dashboard</p>
        </div>
        <div class="flex items-center gap-3">
            <!-- Device selector -->
            <select id="deviceSelect" onchange="changeDevice()"
                class="text-white text-xs font-bold px-3 py-1.5 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500"
                style="background:#1e293b;border:1px solid #334155">
                <option value="1">พัดลม 1</option>
                <option value="2">พัดลม 2</option>
            </select>
            <!-- Online badge -->
            <div id="statusBadge" class="flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold"
                 style="background:#1e293b;border:1px solid #334155;color:#94a3b8">
                <div class="w-2 h-2 rounded-full bg-slate-500"></div>
                <span>–</span>
            </div>
        </div>
    </div>

    <!-- Motion Status Banner -->
    <div class="card-motion rounded-2xl p-4 mb-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <i class="fas fa-satellite-dish text-yellow-400 text-xl"></i>
            <div>
                <p class="text-slate-400 text-xs mb-0.5">สถานะ Ultrasonic</p>
                <div id="motionBig" class="text-xl font-bold text-white leading-none">--</div>
            </div>
        </div>
        <p id="motionSub" class="text-slate-500 text-xs">ไม่มีการเคลื่อนไหว</p>
    </div>

    <!-- Ultrasonic Sensor Distances -->
    <div class="glass-dark rounded-2xl p-4 mb-4">
        <div class="flex items-center gap-2 mb-3">
            <i class="fas fa-radar text-blue-400 text-xs"></i>
            <span class="text-slate-300 text-xs font-bold uppercase tracking-wider">Ultrasonic Sensors (HC-SR04)</span>
        </div>
        <div class="grid grid-cols-2 gap-3" id="sensorGrid">
            <!-- Sensor cards generated by JS -->
        </div>
    </div>

    <!-- Servo Status + Controls -->
    <div class="glass-dark rounded-2xl p-4 mb-4">
        <div class="flex items-center gap-2 mb-3">
            <i class="fas fa-cog text-purple-400 text-xs"></i>
            <span class="text-slate-300 text-xs font-bold uppercase tracking-wider">Servo Control (GP2–GP5)</span>
        </div>
        <div class="grid grid-cols-4 gap-2 mb-4" id="servoGrid">
            <!-- Servo indicators generated by JS -->
        </div>

        <!-- Swing Toggle (full width) -->
        <div id="manualControls" class="transition duration-300">
            <div class="card-swing rounded-xl p-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i id="swingIcon" class="fas fa-arrows-alt-h text-purple-400 text-2xl"></i>
                    <div>
                        <p class="text-white text-sm font-bold">ส่าย (Servo 2–4)</p>
                        <p id="swingStatus" class="text-purple-300 text-xs mt-0.5">หยุดอยู่</p>
                    </div>
                </div>
                <div id="toggleSwingTrack" onclick="toggleSwing()" class="toggle-track off">
                    <div class="toggle-thumb"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="flex items-center justify-between px-1">
        <p class="text-slate-600 text-[11px]" id="lastUpdate">กำลังเชื่อมต่อ...</p>
        <button onclick="logout()" class="text-slate-600 hover:text-red-400 text-[11px] transition btn-press">
            <i class="fas fa-sign-out-alt mr-1"></i>ออกจากระบบ
        </button>
    </div>
</div>

<script>
    // ============================================================
    //  CONFIG
    // ============================================================
    const API_URL = '/api/device?id=1';
    let state = { manual_mode: false, swing_command: false };
    let authToken   = sessionStorage.getItem('fan_token');
    let pollInterval = null;

    // ============================================================
    //  INIT GRIDS
    // ============================================================
    function initGrids() {
        // Sensor grid
        const sg = document.getElementById('sensorGrid');
        sg.innerHTML = '';
        for (let i = 0; i < 4; i++) {
            sg.innerHTML += `
            <div class="rounded-xl p-2.5" style="background:#0f172a;border:1px solid #1e293b">
                <div class="flex items-center justify-between mb-1.5">
                    <span class="text-slate-400 text-[10px] font-bold">S${i+1}</span>
                    <span class="text-[10px] font-bold" id="sDot${i}">●</span>
                </div>
                <p class="text-white font-bold text-base leading-none" id="sDist${i}">– cm</p>
                <div class="mt-2 rounded-full overflow-hidden" style="height:5px;background:#1e293b">
                    <div class="sensor-bar-fill" id="sBar${i}" style="width:0%"></div>
                </div>
                <p class="text-slate-600 text-[9px] mt-1">GP${6+i*2}/GP${7+i*2}</p>
            </div>`;
        }

        // Servo grid
        const srv = document.getElementById('servoGrid');
        srv.innerHTML = '';
        const labels = ['Servo 1','Servo 2','Servo 3','Servo 4'];
        const gpins  = [2,3,4,5];
        for (let i = 0; i < 4; i++) {
            srv.innerHTML += `
            <div class="rounded-xl p-2 text-center" style="background:#0f172a;border:1px solid #1e293b">
                <div class="servo-arc mx-auto mb-1 flex items-center justify-center relative">
                    <svg width="48" height="48" viewBox="0 0 48 48">
                        <circle cx="24" cy="24" r="18" fill="none" stroke="#1e293b" stroke-width="3"/>
                        <path id="srvArc${i}" d="" fill="none" stroke="#334155" stroke-width="3" stroke-linecap="round"/>
                        <line id="srvNeedle${i}" x1="24" y1="24" x2="24" y2="8"
                              stroke="#60a5fa" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </div>
                <p class="text-[9px] text-slate-400">${labels[i]}</p>
                <p class="text-[9px] text-slate-600">GP${gpins[i]}</p>
            </div>`;
        }
    }

    function setServoAngle(i, angle) {
        const needle = document.getElementById(`srvNeedle${i}`);
        if (!needle) return;
        const r = 16, rad = (angle - 90) * Math.PI / 180;
        needle.setAttribute('x2', 24 + r * Math.sin(rad));
        needle.setAttribute('y2', 24 - r * Math.cos(rad));
    }

    function updateSensorUI(index, distCm) {
        const dot  = document.getElementById(`sDot${index}`);
        const disp = document.getElementById(`sDist${index}`);
        const bar  = document.getElementById(`sBar${index}`);
        if (!dot) return;
        const MAX_CM = 200;
        if (distCm <= 0) {
            dot.style.color = '#475569';
            disp.textContent = '– cm';
            bar.style.width = '0%';
        } else {
            const pct = Math.min(distCm / MAX_CM * 100, 100);
            bar.style.width = pct + '%';
            disp.textContent = distCm.toFixed(0) + ' cm';
            dot.style.color = distCm < 50 ? '#ef4444' : distCm < 100 ? '#facc15' : '#22c55e';
        }
    }

    // ============================================================
    //  AUTH
    // ============================================================
    async function login() {
        const pw = document.getElementById('loginPassword').value;
        const errEl = document.getElementById('loginError');
        errEl.classList.add('hidden');
        try {
            const res = await fetch('/api/auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: pw })
            });
            if (res.ok) {
                const { token } = await res.json();
                sessionStorage.setItem('fan_token', token);
                authToken = token;
                document.getElementById('loginModal').classList.add('hidden');
                startApp();
            } else {
                errEl.classList.remove('hidden');
            }
        } catch {
            errEl.textContent = 'เกิดข้อผิดพลาด ลองใหม่';
            errEl.classList.remove('hidden');
        }
    }

    function logout() {
        sessionStorage.removeItem('fan_token');
        authToken = null;
        if (pollInterval) clearInterval(pollInterval);
        document.getElementById('loginModal').classList.remove('hidden');
        document.getElementById('loginPassword').value = '';
    }

    function getAuthHeaders() {
        return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` };
    }

    // ============================================================
    //  APP LIFECYCLE
    // ============================================================
    function startApp() {
        initGrids();
        fetchData();
        pollInterval = setInterval(fetchData, 2000);
    }

    // ============================================================
    //  FETCH + UPDATE UI
    // ============================================================
    async function fetchData() {
        try {
            const res = await fetch(API_URL, { headers: { 'Authorization': `Bearer ${authToken}` } });
            if (res.status === 401) { logout(); return; }
            if (!res.ok) throw new Error('API Error');
            const data = await res.json();
            state = data;
            updateUI(data);
            checkOnlineStatus(data.device_last_seen);
        } catch (e) {
            console.error(e);
            const badge = document.getElementById('statusBadge');
            badge.style.borderColor = '#7f1d1d44';
            badge.innerHTML = '<div class="w-2 h-2 rounded-full bg-red-500"></div><span class="text-red-400">Error</span>';
        }
    }

    function checkOnlineStatus(lastSeenStr) {
        const badge = document.getElementById('statusBadge');
        if (!lastSeenStr) {
            badge.style.cssText = 'background:#1e293b;border:1px solid #334155;color:#94a3b8';
            badge.innerHTML = '<div class="w-2 h-2 rounded-full bg-slate-500"></div><span>ไม่เคยออนไลน์</span>';
            return;
        }
        const diff = (Date.now() - new Date(lastSeenStr).getTime()) / 1000;
        if (diff > 15) {
            badge.style.cssText = 'background:#2d0f0f;border:1px solid #7f1d1d;color:#f87171';
            badge.innerHTML = '<div class="w-2 h-2 rounded-full bg-red-500 ring-anim"></div><span>ออฟไลน์</span>';
        } else {
            badge.style.cssText = 'background:#0f2a1a;border:1px solid #166534;color:#4ade80';
            badge.innerHTML = '<div class="w-2 h-2 rounded-full bg-green-500" style="animation:ring 1.5s ease-out infinite;box-shadow:0 0 0 0 #4ade8066"></div><span>ออนไลน์</span>';
        }
    }

    function updateUI(data) {
        // Motion
        const motionBig = document.getElementById('motionBig');
        const motionSub = document.getElementById('motionSub');
        if (data.motion_detected) {
            motionBig.innerHTML   = '<span class="text-red-400">⚡ เจอ!</span>';
            motionSub.textContent = 'ตรวจพบการเคลื่อนไหว';
            motionSub.className   = 'text-red-400 text-xs animate-pulse';
        } else {
            motionBig.innerHTML   = '<span class="text-green-400">✓ ว่าง</span>';
            motionSub.textContent = 'ไม่มีการเคลื่อนไหว';
            motionSub.className   = 'text-slate-500 text-xs';
        }

        // Sensor bars — ค่าจริงจาก device (ถ้ามี) หรือ simulate
        const dist = data.motion_detected
            ? [Math.random()*60+10, Math.random()*80+20, Math.random()*50+30, Math.random()*70+15]
            : [0, 0, 0, 0];
        for (let i = 0; i < 4; i++) updateSensorUI(i, dist[i]);

        // Servo 1 ตาม motion (AUTO: หมุนเมื่อมีคน)
        setServoAngle(0, data.motion_detected ? 180 : 90);

        // Swing toggle
        const swingTrack = document.getElementById('toggleSwingTrack');
        const swingIcon  = document.getElementById('swingIcon');
        const swingSt    = document.getElementById('swingStatus');
        if (data.swing_command) {
            swingTrack.className = 'toggle-track on';
            swingIcon.className  = 'fas fa-arrows-alt-h text-purple-400 text-2xl';
            swingSt.textContent  = 'กำลังส่าย...';
            animateSwing(true);
        } else {
            swingTrack.className = 'toggle-track off';
            swingIcon.className  = 'fas fa-arrows-alt-h text-slate-500 text-2xl';
            swingSt.textContent  = 'หยุดอยู่';
            animateSwing(false);
            setServoAngle(1, 90); setServoAngle(2, 90); setServoAngle(3, 90);
        }

        document.getElementById('lastUpdate').innerText = 'อัปเดต: ' + new Date().toLocaleTimeString('th-TH');
    }

    // ============================================================
    //  Servo Swing Animation (visual only)
    // ============================================================
    let swingRunning = false;
    let swingTick = 0;
    function animateSwing(enable) {
        if (enable && !swingRunning) {
            swingRunning = true;
            (function tick() {
                if (!swingRunning) return;
                swingTick += 2;
                const a = 90 + 45 * Math.sin(swingTick * Math.PI / 180);
                setServoAngle(1, a); setServoAngle(2, a); setServoAngle(3, a);
                requestAnimationFrame(tick);
            })();
        } else if (!enable) {
            swingRunning = false;
        }
    }

    // ============================================================
    //  COMMANDS
    // ============================================================
    async function sendCommand(swing) {
        state.swing_command = swing;
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify({ from_app: true, swing_command: swing })
        });
        if (res.status === 401) { logout(); return; }
        fetchData();
    }

    function toggleSwing() { sendCommand(!state.swing_command); }

    // ============================================================
    //  BOOT
    // ============================================================
    if (authToken) {
        document.getElementById('loginModal').classList.add('hidden');
        startApp();
    }
</script>
</body>
</html>